<!-- 
MINDMATCH v2.5
- LAYOUT ENGINE UPDATE:
  - Fix: Switched main screens to `overflow-y: auto` and `justify-content: flex-start`.
  - Result: The Main Menu is now scrollable on small screens instead of being cut off.
- UI SAFETY ZONE:
  - Fix: Added global top padding (85px) to game screens.
  - Result: The "Shapes" drop zones no longer overlap the Home button on mobile.
- CORE: Maintained all v2.4 game logic and assets.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mind Matcher Suite</title>
    
    <!-- iOS / PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mind Matcher">
    <meta name="theme-color" content="#ffffff">

    <style>
        :root {
            --card-size: 130px;
            --gap-size: 30px;
            --mole-size: 110px;
            /* INCREASED SHAPE SIZE FOR TANGRAM */
            --shape-size: 160px;
            --primary-color: #FF9F1C;
            --bg-transition: background 1s ease;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            /* Changed from hidden to allowing screen management */
            overflow: hidden; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: #f0f0f0; /* Default menu bg */
            transition: var(--bg-transition);
        }

        /* --- SCREENS (SCROLL FIX APPLIED HERE) --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            /* Fix for scrolling issues: */
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 40px; /* Bottom buffer */
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Changed from center to flex-start to allow scrolling from top */
            justify-content: flex-start; 
            /* Fix for overlapping home button: Pushes content down */
            padding-top: 85px; 
        }

        /* Special handling for Main Menu which doesn't have a visible home button */
        #main-menu.active {
            padding-top: 40px; /* Less padding needed since no button */
            justify-content: center; /* Try to center, but... */
        }
        
        /* Media query: If screen is short, align top so we can scroll */
        @media (max-height: 800px) {
            #main-menu.active {
                justify-content: flex-start;
            }
        }

        /* --- HOME BUTTON --- */
        #home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            border: 4px solid #333;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: none; /* Hidden on menu */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #home-btn svg { width: 35px; height: 35px; fill: #333; }

        /* --- MAIN MENU --- */
        #main-menu {
            background-color: #E0F7FA;
            background-image: radial-gradient(#B2EBF2 20%, transparent 20%);
            background-size: 30px 30px;
        }

        .menu-title {
            font-size: 3rem;
            color: #0097A7;
            margin-bottom: 30px;
            text-shadow: 2px 2px white;
            text-align: center;
            margin-top: 20px;
        }

        .menu-grid {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 20px; /* Side padding for small screens */
            padding-bottom: 50px; /* Extra space at bottom for scroll */
        }

        .game-card {
            width: 180px;
            height: 220px;
            background: white;
            border-radius: 20px;
            border: 6px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 0 #333;
            transition: transform 0.1s;
            flex-shrink: 0; /* Prevent squishing */
        }

        .game-card:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #333;
        }

        .game-card svg { width: 90px; height: 90px; margin-bottom: 15px; }
        .game-card span { font-size: 1.4rem; font-weight: bold; color: #333; }

        /* --- GAME A: MEMORY STYLES --- */
        body.theme-construction { background-color: #f4e7c3; background-image: radial-gradient(#d3c091 15%, transparent 16%), radial-gradient(#d3c091 15%, transparent 16%); background-size: 60px 60px; background-position: 0 0, 30px 30px; }
        body.theme-colors { background-color: #ffffff; background-image: radial-gradient(#FFADAD 20%, transparent 20%), radial-gradient(#FDFFB6 20%, transparent 20%); background-size: 50px 50px; background-position: 0 0, 25px 25px; }
        body.theme-numbers { background-color: #e0f7fa; background-image: linear-gradient(#b2ebf2 1px, transparent 1px), linear-gradient(90deg, #b2ebf2 1px, transparent 1px); background-size: 40px 40px; }
        body.theme-letters { background-color: #fff9c4; background-image: linear-gradient(#cfd8dc 1px, transparent 1px); background-size: 100% 40px; }
        body.theme-animals { background-color: #e8f5e9; background-image: radial-gradient(#c8e6c9 10%, transparent 11%); background-size: 40px 40px; }
        body.theme-fruit { background-color: #ffebee; background-image: repeating-linear-gradient(45deg, #ffcdd2 25%, transparent 25%, transparent 75%, #ffcdd2 75%, #ffcdd2), repeating-linear-gradient(45deg, #ffcdd2 25%, #ffebee 25%, #ffebee 75%, #ffcdd2 75%, #ffcdd2); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        body.theme-space { background-color: #2c3e50; background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px); background-size: 50px 50px; background-position: 0 0, 25px 25px; }
        body.theme-weather { background-color: #81D4FA; background-image: radial-gradient(circle at 50% 50%, #B3E5FC 10%, transparent 10%); background-size: 80px 80px; }
        body.theme-ocean { background-color: #00BCD4; background-image: radial-gradient(rgba(255,255,255,0.2) 20%, transparent 20%); background-size: 30px 30px; }

        #memory-board {
            display: grid;
            grid-template-columns: repeat(4, var(--card-size));
            gap: var(--gap-size);
            perspective: 1000px;
            margin-bottom: 20px;
        }

        .card {
            width: var(--card-size); height: var(--card-size); position: relative;
            transform-style: preserve-3d; transition: transform 0.5s; cursor: pointer;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { animation: popOut 0.5s forwards; pointer-events: none; }
        @keyframes popOut { 50% { transform: rotateY(180deg) scale(1.2); opacity: 1; } 100% { transform: rotateY(180deg) scale(0); opacity: 0; } }

        .card-face {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            backface-visibility: hidden; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 5px solid #333; background: white;
        }
        .card-front { background: var(--primary-color); color: white; transform: rotateY(0deg); }
        .card-front::after { content: "?"; font-size: 50px; font-weight: bold; text-shadow: 2px 2px 0 #c4760d; }
        .card-back { transform: rotateY(180deg); }
        .card-back svg { width: 85%; height: 85%; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.15)); }
        
        .wiggle { animation: wiggle 1s ease-in-out infinite; }
        @keyframes wiggle { 0%, 100% { transform: rotateY(0deg) rotateZ(0deg); } 25% { transform: rotateY(0deg) rotateZ(-5deg); } 75% { transform: rotateY(0deg) rotateZ(5deg); } }

        /* --- GAME B: WHACK-A-MOLE STYLES --- */
        body.theme-whack-grass { background-color: #8BC34A; background-image: repeating-linear-gradient(45deg, #7CB342 25%, transparent 25%, transparent 75%, #7CB342 75%, #7CB342), repeating-linear-gradient(45deg, #7CB342 25%, #8BC34A 25%, #8BC34A 75%, #7CB342 75%, #7CB342); background-position: 0 0, 20px 20px; background-size: 40px 40px; }
        body.theme-whack-desert { background-color: #FDD835; background-image: radial-gradient(#FBC02D 20%, transparent 20%), radial-gradient(#FBC02D 20%, transparent 20%); background-size: 60px 60px; background-position: 0 0, 30px 30px; }
        body.theme-whack-snow { background-color: #E1F5FE; background-image: linear-gradient(#B3E5FC 2px, transparent 2px), linear-gradient(90deg, #B3E5FC 2px, transparent 2px); background-size: 50px 50px; }
        body.theme-whack-night { background-color: #1A237E; background-image: radial-gradient(white 1px, transparent 1px); background-size: 50px 50px; }

        #whack-board { display: grid; grid-template-columns: repeat(3, var(--mole-size)); gap: 20px; margin-top: 20px; }
        .hole { width: var(--mole-size); height: var(--mole-size); background: #5D4037; border-radius: 50%; border: 5px solid #3E2723; position: relative; overflow: hidden; box-shadow: inset 0 10px 10px rgba(0,0,0,0.5); transition: border-color 0.5s; }
        body.theme-whack-snow .hole { border-color: #B3E5FC; }
        body.theme-whack-night .hole { border-color: #3949AB; }

        .mole { width: 80%; height: 80%; position: absolute; bottom: -100%; left: 10%; transition: bottom 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .mole.up { bottom: 0; }
        .mole.bonked { transform: scale(0.9) rotate(10deg); filter: grayscale(100%); }

        /* --- GAME C: SHADOWS (SHAPE MATCH) STYLES --- */
        /* Shadow Theme 1: Lavender (Default) */
        body.theme-shadows-lavender {
            background-color: #F3E5F5;
            background-image: radial-gradient(#E1BEE7 20%, transparent 20%);
            background-size: 40px 40px;
        }
        /* Shadow Theme 2: Sky */
        body.theme-shadows-sky {
            background-color: #E3F2FD;
            background-image: radial-gradient(circle, #90CAF9 10%, transparent 10%);
            background-size: 60px 60px;
        }
        /* Shadow Theme 3: Sunset */
        body.theme-shadows-sunset {
            background-color: #FFF3E0;
            background-image: linear-gradient(to top right, #FFE0B2 50%, transparent 50%);
            background-size: 40px 40px;
        }
        /* Shadow Theme 4: Forest */
        body.theme-shadows-forest {
            background-color: #E8F5E9;
            background-image: linear-gradient(#C8E6C9 2px, transparent 2px), linear-gradient(90deg, #C8E6C9 2px, transparent 2px);
            background-size: 50px 50px;
        }


        #shadow-game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Changed from space-between to start to allow padding to work */
            justify-content: flex-start; 
            gap: 15vh; /* Responsive gap */
            width: 100%;
            max-width: 600px;
            /* Allow it to take natural height */
            height: auto; 
            min-height: 60vh;
        }

        .shadow-row, .piece-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .target-slot {
            width: var(--shape-size);
            height: var(--shape-size);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            background: rgba(0,0,0,0.05);
            border: 4px dashed #999;
        }

        .target-slot svg {
            width: 80%;
            height: 80%;
            fill: #ccc !important; /* Force shadow color */
            stroke: none !important;
            filter: grayscale(100%);
            opacity: 0.5;
        }
        
        /* When a piece is dropped successfully */
        .target-slot.filled {
            border: 4px solid #4CAF50;
            background: white;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .target-slot.filled svg {
            fill: initial !important; /* Restore color */
            stroke: #333 !important;
            filter: none;
            opacity: 1;
        }
        @keyframes popIn { from { transform: scale(0.5); } to { transform: scale(1); } }

        .draggable-piece {
            width: var(--shape-size);
            height: var(--shape-size);
            touch-action: none; /* Critical for drag */
            cursor: grab;
            position: relative;
            z-index: 10;
            transition: transform 0.1s;
        }
        .draggable-piece:active { cursor: grabbing; transform: scale(1.1); }
        .draggable-piece svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.2));
            pointer-events: none; /* Clicks go through to container */
        }
        .draggable-piece.hidden { opacity: 0; pointer-events: none; }


        /* Responsive */
        @media (max-width: 600px) {
            :root { --card-size: 100px; --gap-size: 20px; --mole-size: 90px; --shape-size: 90px; }
            #memory-board { grid-template-columns: repeat(2, var(--card-size)); }
            .menu-grid { flex-direction: column; gap: 20px; }
            
            /* Reduced gap on mobile for shadows */
            #shadow-game-container { gap: 10vh; }
            .shadow-row, .piece-row { gap: 10px; }
        }

        /* --- OVERLAYS --- */
        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        #win-text { font-size: 5rem; color: #FF4081; text-shadow: 2px 2px 0 #fff; opacity: 0; transition: opacity 0.5s; font-weight: 900; }
    </style>
</head>
<body>

    <!-- HOME BUTTON -->
    <div id="home-btn" onclick="goHome()">
        <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>
    </div>

    <!-- SCREEN 1: MAIN MENU -->
    <div id="main-menu" class="screen active">
        <h1 class="menu-title">Mind Matcher</h1>
        <div class="menu-grid">
            <div class="game-card" onclick="startGame('memory')">
                <svg viewBox="0 0 100 100"><path d="M30,50 Q30,30 50,30 Q60,30 65,40 Q75,40 80,50 Q80,70 50,70 Q30,70 30,50" fill="#FFEB3B" stroke="#333" stroke-width="4"/><circle cx="45" cy="45" r="3" fill="black"/><path d="M20,50 L30,55 L30,45 Z" fill="orange" stroke="#333" stroke-width="2"/></svg>
                <span>Memory</span>
            </div>
            <div class="game-card" onclick="startGame('whack')">
                <svg viewBox="0 0 100 100"><path d="M20,80 Q20,30 50,30 Q80,30 80,80" fill="#A1887F" stroke="#333" stroke-width="4"/><circle cx="40" cy="50" r="3" fill="black"/><circle cx="60" cy="50" r="3" fill="black"/><ellipse cx="50" cy="60" rx="6" ry="4" fill="#333"/><path d="M40,30 Q50,10 60,30" fill="none" stroke="#333" stroke-width="2"/></svg>
                <span>Whack!</span>
            </div>
            <!-- New Shadows Game Card -->
            <div class="game-card" onclick="startGame('shadows')">
                <svg viewBox="0 0 100 100"><path d="M50,10 L90,90 L10,90 Z" fill="#9C27B0" stroke="#333" stroke-width="4" stroke-linejoin="round"/><circle cx="50" cy="60" r="10" fill="white" opacity="0.5"/></svg>
                <span>Shapes</span>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: MEMORY GAME -->
    <div id="memory-screen" class="screen">
        <div id="memory-board"></div>
    </div>

    <!-- SCREEN 3: WHACK-A-MOLE -->
    <div id="whack-screen" class="screen">
        <div id="whack-board"></div>
    </div>

    <!-- SCREEN 4: SHADOWS GAME -->
    <div id="shadows-screen" class="screen">
        <div id="shadow-game-container">
            <div class="shadow-row" id="shadow-targets">
                <!-- Targets Generated by JS -->
            </div>
            <div class="piece-row" id="shadow-pieces">
                <!-- Draggables Generated by JS -->
            </div>
        </div>
    </div>

    <!-- Win Overlay -->
    <div id="win-overlay"><div id="win-text">YAY!</div></div>

    <!-- Confetti Canvas -->
    <canvas id="confetti" style="position:fixed; top:0; left:0; pointer-events:none; width:100%; height:100%;"></canvas>

<script>
    /**
     * MIND MATCH SUITE v2.5
     * Includes: Memory, Whack-a-Mole, and Shadows (Shapes)
     */

    // --- Audio System ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioCtx();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'flip' || type === 'snap') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gainNode.gain.setValueAtTime(0.8, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'match' || type === 'success') {
            playNote(523.25, now, 0.1, 'sine'); playNote(659.25, now + 0.1, 0.3, 'sine');
        } else if (type === 'win') {
            playNote(523.25, now, 0.1, 'triangle'); playNote(659.25, now + 0.1, 0.1, 'triangle');
            playNote(783.99, now + 0.2, 0.1, 'triangle'); playNote(1046.50, now + 0.3, 0.6, 'triangle');
        } else if (type === 'bonk') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
            gainNode.gain.setValueAtTime(0.8, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'pop') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(300, now + 0.1);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        }
    }

    function playNote(freq, time, duration, type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.8, time);
        gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
        osc.start(time); osc.stop(time + duration);
    }

    // --- Navigation ---
    let currentGame = null;

    function startGame(gameType) {
        initAudio();
        document.getElementById('main-menu').classList.remove('active');
        document.getElementById('home-btn').style.display = 'flex';
        currentGame = gameType;

        if (gameType === 'memory') {
            document.getElementById('memory-screen').classList.add('active');
            initMemoryGame();
        } else if (gameType === 'whack') {
            document.getElementById('whack-screen').classList.add('active');
            initWhackGame();
        } else if (gameType === 'shadows') {
            document.getElementById('shadows-screen').classList.add('active');
            initShadowGameStart(); // Use new starter for randomization
        }
    }

    function goHome() {
        stopWhackGame();
        clearTimeout(idleTimer);
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('main-menu').classList.add('active');
        document.getElementById('home-btn').style.display = 'none';
        document.body.className = '';
        document.body.style.backgroundColor = '#f0f0f0';
        currentGame = null;
    }

    /* =========================================
       ASSETS
       ========================================= */
    const allSvgs = {
        // Original Set
        excavator: `<svg viewBox="0 0 100 100"><path d="M10,80 L40,80 L40,60 L20,60 L20,50 L50,50 L60,30 L80,30 L80,50 L90,80 L10,80" fill="#FFC107" stroke="#333" stroke-width="6" stroke-linejoin="round"/><circle cx="25" cy="80" r="8" fill="#333"/><circle cx="75" cy="80" r="8" fill="#333"/></svg>`,
        bulldozer: `<svg viewBox="0 0 100 100"><path d="M10,70 L30,70 L30,50 L60,50 L60,40 L40,40 L10,70" fill="#FB8C00" stroke="#333" stroke-width="6" stroke-linejoin="round"/><rect x="60" y="40" width="30" height="30" fill="#FFC107" stroke="#333" stroke-width="6"/><circle cx="40" cy="75" r="8" fill="#333"/><circle cx="80" cy="75" r="8" fill="#333"/></svg>`,
        truck: `<svg viewBox="0 0 100 100"><path d="M10,40 L60,40 L60,70 L10,70 Z" fill="#E53935" stroke="#333" stroke-width="6" stroke-linejoin="round"/><rect x="65" y="50" width="25" height="20" fill="#42A5F5" stroke="#333" stroke-width="6"/><circle cx="30" cy="75" r="8" fill="#333"/><circle cx="75" cy="75" r="8" fill="#333"/></svg>`,
        mixer: `<svg viewBox="0 0 100 100"><circle cx="45" cy="45" r="25" fill="#90A4AE" stroke="#333" stroke-width="6"/><rect x="60" y="50" width="30" height="20" fill="#F1C40F" stroke="#333" stroke-width="6"/><circle cx="30" cy="75" r="8" fill="#333"/><circle cx="80" cy="75" r="8" fill="#333"/></svg>`,
        firetruck: `<svg viewBox="0 0 100 100"><path d="M10,50 h60 v20 h-60 z" fill="#D32F2F" stroke="#333" stroke-width="4"/><rect x="70" y="55" width="20" height="15" fill="#D32F2F" stroke="#333" stroke-width="4"/><circle cx="25" cy="75" r="8"/><circle cx="80" cy="75" r="8"/><rect x="20" y="40" width="40" height="10" fill="#ccc" stroke="#333" stroke-width="2"/></svg>`,
        whale: `<svg viewBox="0 0 100 100"><path d="M20,60 Q20,30 50,30 Q80,30 90,60 Q80,80 50,80 Q30,80 20,60" fill="#2196F3" stroke="#333" stroke-width="4"/><circle cx="35" cy="50" r="3" fill="white"/></svg>`,
        duck: `<svg viewBox="0 0 100 100"><path d="M30,50 Q30,30 50,30 Q60,30 65,40 Q75,40 80,50 Q80,70 50,70 Q30,70 30,50" fill="#FFEB3B" stroke="#333" stroke-width="4"/><circle cx="45" cy="45" r="3" fill="black"/><path d="M20,50 L30,55 L30,45 Z" fill="orange" stroke="#333" stroke-width="2"/></svg>`,
        frog: `<svg viewBox="0 0 100 100"><circle cx="50" cy="60" r="25" fill="#76FF03" stroke="#333" stroke-width="4"/><circle cx="40" cy="45" r="8" fill="#76FF03" stroke="#333" stroke-width="4"/><circle cx="60" cy="45" r="8" fill="#76FF03" stroke="#333" stroke-width="4"/><circle cx="40" cy="45" r="3" fill="black"/><circle cx="60" cy="45" r="3" fill="black"/></svg>`,
        cat: `<svg viewBox="0 0 100 100"><circle cx="50" cy="55" r="25" fill="#9E9E9E" stroke="#333" stroke-width="4"/><polygon points="30,40 25,20 45,35" fill="#9E9E9E" stroke="#333" stroke-width="4" stroke-linejoin="round"/><polygon points="70,40 75,20 55,35" fill="#9E9E9E" stroke="#333" stroke-width="4" stroke-linejoin="round"/><circle cx="42" cy="50" r="3"/><circle cx="58" cy="50" r="3"/><path d="M45,60 Q50,65 55,60" fill="none" stroke="black" stroke-width="3"/></svg>`,
        dog: `<svg viewBox="0 0 100 100"><path d="M30,40 Q50,20 70,40 Q70,70 50,70 Q30,70 30,40" fill="#795548" stroke="#333" stroke-width="4"/><ellipse cx="40" cy="45" rx="3" ry="5" fill="black"/><ellipse cx="60" cy="45" rx="3" ry="5" fill="black"/><path d="M45,60 Q50,55 55,60" fill="none" stroke="black" stroke-width="3"/><ellipse cx="25" cy="45" rx="5" ry="15" fill="#5D4037" stroke="#333" stroke-width="2"/><ellipse cx="75" cy="45" rx="5" ry="15" fill="#5D4037" stroke="#333" stroke-width="2"/></svg>`,
        lion: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="#F39C12" stroke="#333" stroke-width="4"/><circle cx="50" cy="50" r="20" fill="#F1C40F" stroke="#333" stroke-width="3"/><circle cx="42" cy="45" r="3"/><circle cx="58" cy="45" r="3"/><path d="M45,55 Q50,60 55,55" stroke="black" stroke-width="3"/></svg>`,
        elephant: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#B0BEC5" stroke="#333" stroke-width="4"/><circle cx="40" cy="45" r="3"/><circle cx="60" cy="45" r="3"/><path d="M50,55 Q50,80 70,70" fill="none" stroke="#B0BEC5" stroke-width="6"/><circle cx="20" cy="40" r="15" fill="#B0BEC5" stroke="#333" stroke-width="4"/><circle cx="80" cy="40" r="15" fill="#B0BEC5" stroke="#333" stroke-width="4"/></svg>`,
        apple: `<svg viewBox="0 0 100 100"><circle cx="50" cy="55" r="25" fill="#F44336" stroke="#333" stroke-width="4"/><path d="M50,30 L50,20" stroke="#5D4037" stroke-width="4"/><path d="M50,30 Q60,20 60,30" fill="none" stroke="#4CAF50" stroke-width="4"/></svg>`,
        banana: `<svg viewBox="0 0 100 100"><path d="M30,80 Q50,10 80,40 Q60,30 30,80 Z" fill="#FFEB3B" stroke="#333" stroke-width="4" stroke-linejoin="round"/></svg>`,
        rocket: `<svg viewBox="0 0 100 100"><path d="M50,10 Q20,60 20,80 L80,80 Q80,60 50,10 Z" fill="#E0E0E0" stroke="#333" stroke-width="4" stroke-linejoin="round"/><circle cx="50" cy="50" r="10" fill="#81D4FA" stroke="#333" stroke-width="4"/><path d="M20,80 L10,95 L30,95 L20,80 Z" fill="#F44336" stroke="#333" stroke-width="4"/><path d="M80,80 L90,95 L70,95 L80,80 Z" fill="#F44336" stroke="#333" stroke-width="4"/></svg>`,
        planet: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#FF9800" stroke="#333" stroke-width="4"/><path d="M20,60 Q50,90 80,40" fill="none" stroke="#333" stroke-width="6"/><path d="M20,60 Q50,90 80,40" fill="none" stroke="#FFCC80" stroke-width="3"/></svg>`,
        moon: `<svg viewBox="0 0 100 100"><path d="M60,20 A30,30 0 1,0 60,80 A20,20 0 1,1 60,20 Z" fill="#FFF176" stroke="#333" stroke-width="4" stroke-linejoin="round"/></svg>`,
        sun: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="20" fill="#FFEB3B" stroke="#333" stroke-width="4"/><g stroke="#333" stroke-width="4"><path d="M50,10 L50,25"/><path d="M50,75 L50,90"/><path d="M10,50 L25,50"/><path d="M75,50 L90,50"/><path d="M22,22 L32,32"/><path d="M68,68 L78,78"/><path d="M22,78 L32,68"/><path d="M68,32 L78,22"/></g></svg>`,
        cloud: `<svg viewBox="0 0 100 100"><path d="M20,60 Q10,60 10,50 Q10,30 30,30 Q40,10 60,30 Q80,20 90,40 Q100,60 80,70 Q60,80 20,60 Z" fill="#E0F7FA" stroke="#333" stroke-width="4" stroke-linejoin="round"/></svg>`,
        fish: `<svg viewBox="0 0 100 100"><path d="M80,50 Q60,20 20,50 Q60,80 80,50 L95,65 L95,35 L80,50 Z" fill="#FF9800" stroke="#333" stroke-width="4" stroke-linejoin="round"/><circle cx="35" cy="45" r="3" fill="black"/></svg>`,
        crab: `<svg viewBox="0 0 100 100"><path d="M20,50 Q50,20 80,50 Q80,70 50,70 Q20,70 20,50" fill="#F44336" stroke="#333" stroke-width="4"/><circle cx="35" cy="45" r="3" fill="black"/><circle cx="65" cy="45" r="3" fill="black"/><path d="M10,40 L20,50 M90,40 L80,50" stroke="#333" stroke-width="4"/></svg>`,
        
        // Restored Items
        grape: `<svg viewBox="0 0 100 100"><g stroke="#333" stroke-width="2"><circle cx="50" cy="70" r="8" fill="#AB47BC"/><circle cx="40" cy="55" r="8" fill="#AB47BC"/><circle cx="60" cy="55" r="8" fill="#AB47BC"/><circle cx="30" cy="40" r="8" fill="#AB47BC"/><circle cx="50" cy="40" r="8" fill="#AB47BC"/><circle cx="70" cy="40" r="8" fill="#AB47BC"/></g><rect x="48" y="20" width="4" height="20" fill="#5D4037"/></svg>`,
        strawberry: `<svg viewBox="0 0 100 100"><path d="M30,30 Q50,100 70,30 Q50,10 30,30" fill="#E91E63" stroke="#333" stroke-width="4"/><path d="M30,30 L40,20 L50,30 L60,20 L70,30" fill="none" stroke="#4CAF50" stroke-width="4" stroke-linejoin="round"/></svg>`,
        alien: `<svg viewBox="0 0 100 100"><path d="M20,30 Q50,0 80,30 Q90,60 50,90 Q10,60 20,30 Z" fill="#76FF03" stroke="#333" stroke-width="4"/><circle cx="35" cy="45" r="5" fill="black"/><circle cx="65" cy="45" r="5" fill="black"/><path d="M40,70 Q50,80 60,70" fill="none" stroke="#333" stroke-width="3"/></svg>`,
        umbrella: `<svg viewBox="0 0 100 100"><path d="M10,50 Q50,0 90,50" fill="#E91E63" stroke="#333" stroke-width="4"/><rect x="48" y="50" width="4" height="30" fill="#333"/><path d="M48,80 Q48,90 58,90" fill="none" stroke="#333" stroke-width="4"/></svg>`,
        snowman: `<svg viewBox="0 0 100 100"><circle cx="50" cy="70" r="20" fill="white" stroke="#333" stroke-width="4"/><circle cx="50" cy="40" r="15" fill="white" stroke="#333" stroke-width="4"/><circle cx="45" cy="35" r="2" fill="black"/><circle cx="55" cy="35" r="2" fill="black"/><rect x="35" y="20" width="30" height="5" fill="#333"/><rect x="40" y="5" width="20" height="15" fill="#333"/></svg>`,
        octopus: `<svg viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="#9C27B0" stroke="#333" stroke-width="4"/><path d="M30,55 Q20,80 30,90 M40,60 Q40,85 50,90 M60,60 Q60,85 70,90 M70,55 Q80,80 70,90" fill="none" stroke="#9C27B0" stroke-width="6" stroke-linecap="round"/><circle cx="42" cy="40" r="3" fill="white"/><circle cx="58" cy="40" r="3" fill="white"/></svg>`,
        starfish: `<svg viewBox="0 0 100 100"><path d="M50,10 L60,40 L95,40 L65,60 L75,90 L50,70 L25,90 L35,60 L5,40 L40,40 Z" fill="#FF5722" stroke="#333" stroke-width="4" stroke-linejoin="round"/></svg>`,

        // NEW: Geometric Shapes
        triangle: `<svg viewBox="0 0 100 100"><polygon points="50,15 90,85 10,85" fill="#9C27B0" stroke="#333" stroke-width="4"/></svg>`,
        square: `<svg viewBox="0 0 100 100"><rect x="15" y="15" width="70" height="70" fill="#2196F3" stroke="#333" stroke-width="4"/></svg>`,
        circle: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="35" fill="#F44336" stroke="#333" stroke-width="4"/></svg>`,
        star: `<svg viewBox="0 0 100 100"><polygon points="50,10 61,40 95,40 68,60 78,90 50,75 22,90 32,60 5,40 39,40" fill="#FFEB3B" stroke="#333" stroke-width="4"/></svg>`,
        heart: `<svg viewBox="0 0 100 100"><path d="M50,30 L50,80 M50,30 Q30,0 10,30 Q0,50 50,90 Q100,50 90,30 Q70,0 50,30" fill="#E91E63" stroke="#333" stroke-width="4" stroke-linejoin="round"/></svg>`,
        diamond: `<svg viewBox="0 0 100 100"><polygon points="50,10 90,50 50,90 10,50" fill="#00BCD4" stroke="#333" stroke-width="4"/></svg>`,
    };
    
    // Memory uses subsets
    const themes = [
        { name: 'construction', icons: ['excavator', 'bulldozer', 'truck', 'mixer'] },
        { name: 'colors', icons: ['firetruck', 'whale', 'duck', 'frog'] },
        { name: 'animals', icons: ['cat', 'dog', 'lion', 'elephant'] },
        { name: 'fruit', icons: ['apple', 'banana', 'grape', 'strawberry'] },
        { name: 'space', icons: ['rocket', 'planet', 'moon', 'alien'] },
        { name: 'weather', icons: ['sun', 'cloud', 'umbrella', 'snowman'] },
        { name: 'ocean', icons: ['fish', 'crab', 'octopus', 'starfish'] }
    ];

    /* =========================================
       GAME A: MEMORY LOGIC
       ========================================= */
    let currentThemeIndex = 0;
    let hasFlippedCard = false, lockBoard = false;
    let firstCard, secondCard;
    let matchesFound = 0;
    const TOTAL_PAIRS = 4;
    let idleTimer;

    function initMemoryGame() {
        currentThemeIndex = Math.floor(Math.random() * themes.length);
        loadMemoryLevel(currentThemeIndex);
    }

    function loadMemoryLevel(index) {
        matchesFound = 0;
        const theme = themes[index];
        const board = document.getElementById('memory-board');
        document.body.className = `theme-${theme.name}`;
        
        let deck = [...theme.icons, ...theme.icons];
        deck.sort(() => 0.5 - Math.random());
        board.innerHTML = '';
        deck.forEach(iconName => {
            const card = document.createElement('div');
            card.classList.add('card'); card.dataset.icon = iconName;
            // Use allSvgs map, fallback if needed
            const svg = allSvgs[iconName] || `<svg viewBox="0 0 100 100"><text x="50" y="50" font-size="50">${iconName[0]}</text></svg>`;
            card.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back">${svg}</div>`;
            card.addEventListener('click', flipCard);
            board.appendChild(card);
        });
        resetIdleTimer();
    }

    function flipCard() {
        if (lockBoard || this === firstCard) return;
        resetIdleTimer();
        this.classList.add('flipped'); playSound('flip');
        if (!hasFlippedCard) { hasFlippedCard = true; firstCard = this; return; }
        secondCard = this; checkForMatch();
    }

    function checkForMatch() {
        let isMatch = firstCard.dataset.icon === secondCard.dataset.icon;
        isMatch ? disableCards() : unflipCards();
    }

    function disableCards() {
        lockBoard = true; playSound('match');
        setTimeout(() => {
            firstCard.classList.add('matched'); secondCard.classList.add('matched');
            resetBoard(); matchesFound++;
            if (matchesFound === TOTAL_PAIRS) setTimeout(() => {
                handleWin();
                setTimeout(() => { 
                    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                    loadMemoryLevel(currentThemeIndex); 
                }, 3000);
            }, 500);
        }, 500);
    }

    function unflipCards() {
        lockBoard = true;
        setTimeout(() => { firstCard.classList.remove('flipped'); secondCard.classList.remove('flipped'); resetBoard(); }, 1000);
    }

    function resetBoard() { [hasFlippedCard, lockBoard] = [false, false]; [firstCard, secondCard] = [null, null]; }
    
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('wiggle'));
        idleTimer = setTimeout(() => {
            const unflipped = document.querySelectorAll('.card:not(.flipped):not(.matched)');
            unflipped.forEach(c => c.classList.add('wiggle'));
        }, 10000);
    }

    /* =========================================
       GAME B: WHACK-A-MOLE LOGIC
       ========================================= */
    const moleSvg = `<svg class="mole" viewBox="0 0 100 100"><path d="M20,100 Q20,20 50,20 Q80,20 80,100" fill="#A1887F" stroke="#5D4037" stroke-width="4"/><circle cx="40" cy="50" r="4" fill="black"/><circle cx="60" cy="50" r="4" fill="black"/><ellipse cx="50" cy="65" rx="8" ry="5" fill="#333"/><path d="M40,30 Q50,10 60,30" fill="none" stroke="#333" stroke-width="3"/><path d="M30,100 Q50,80 70,100" fill="#EFEBE9"/></svg>`;
    let whackLoop = null, whackScore = 0;
    const WHACK_WIN_THRESHOLD = 6;
    const whackThemes = ['grass', 'desert', 'snow', 'night'];
    let currentWhackThemeIndex = 0;

    function initWhackGame() {
        currentWhackThemeIndex = Math.floor(Math.random() * whackThemes.length);
        setWhackTheme(currentWhackThemeIndex);
        whackScore = 0;
        const board = document.getElementById('whack-board');
        board.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const hole = document.createElement('div');
            hole.classList.add('hole');
            hole.innerHTML = moleSvg;
            hole.querySelector('.mole').addEventListener('click', bonk);
            board.appendChild(hole);
        }
        startMoleLoop();
    }
    
    function setWhackTheme(idx) {
        document.body.className = '';
        document.body.classList.add(`theme-whack-${whackThemes[idx]}`);
    }

    function startMoleLoop() {
        const randomTime = Math.random() * 1000 + 1000;
        whackLoop = setTimeout(() => { showMole(); startMoleLoop(); }, randomTime);
    }

    function showMole() {
        if (currentGame !== 'whack') return;
        const holes = document.querySelectorAll('.hole');
        const idx = Math.floor(Math.random() * holes.length);
        const hole = holes[idx];
        const mole = hole.querySelector('.mole');
        if (!mole.classList.contains('up')) {
            playSound('pop'); mole.classList.add('up');
            setTimeout(() => { if(mole.classList.contains('up') && !mole.classList.contains('bonked')) mole.classList.remove('up'); }, 1500);
        }
    }

    function bonk(e) {
        if (!e.isTrusted) return;
        const mole = this;
        if (!mole.classList.contains('bonked')) {
            mole.classList.add('bonked'); playSound('bonk'); whackScore++;
            if (whackScore >= WHACK_WIN_THRESHOLD) {
                whackScore = 0; handleWin();
                setTimeout(() => {
                    let newIdx = currentWhackThemeIndex;
                    while(newIdx === currentWhackThemeIndex) newIdx = Math.floor(Math.random() * whackThemes.length);
                    currentWhackThemeIndex = newIdx; setWhackTheme(currentWhackThemeIndex);
                }, 2000);
            }
            setTimeout(() => { mole.classList.remove('up'); setTimeout(() => { mole.classList.remove('bonked'); }, 200); }, 200);
        }
    }
    function stopWhackGame() { clearTimeout(whackLoop); }

    /* =========================================
       GAME C: SHADOWS LOGIC (SHAPE MATCH)
       ========================================= */
    let shadowsSolved = 0;
    const shadowThemes = ['lavender', 'sky', 'sunset', 'forest'];
    let currentShadowThemeIndex = 0;
    
    // NEW: Function to set theme for shadows
    function setShadowTheme(idx) {
        document.body.className = '';
        document.body.classList.add(`theme-shadows-${shadowThemes[idx]}`);
    }

    // NEW: Function to start shadow game with randomization
    function initShadowGameStart() {
        // Random theme on start
        currentShadowThemeIndex = Math.floor(Math.random() * shadowThemes.length);
        setShadowTheme(currentShadowThemeIndex);
        initShadowGame();
    }
    
    function initShadowGame() {
        shadowsSolved = 0;
        // 1. Pick 3 random distinct icons from allSvgs
        const keys = Object.keys(allSvgs);
        // shuffle keys
        keys.sort(() => 0.5 - Math.random());
        const selectedKeys = keys.slice(0, 3);
        
        // 2. Render Targets (Shadows)
        const targetContainer = document.getElementById('shadow-targets');
        targetContainer.innerHTML = '';
        selectedKeys.forEach(key => {
            const slot = document.createElement('div');
            slot.classList.add('target-slot');
            slot.dataset.target = key;
            // Greyed out svg
            slot.innerHTML = allSvgs[key];
            targetContainer.appendChild(slot);
        });

        // 3. Render Draggables (Pieces)
        const pieceContainer = document.getElementById('shadow-pieces');
        pieceContainer.innerHTML = '';
        // Shuffle pieces so they aren't directly below targets
        const pieceKeys = [...selectedKeys].sort(() => 0.5 - Math.random());
        
        pieceKeys.forEach(key => {
            const piece = document.createElement('div');
            piece.classList.add('draggable-piece');
            piece.dataset.icon = key;
            piece.innerHTML = allSvgs[key];
            
            // Add Drag Logic
            addDragLogic(piece);
            pieceContainer.appendChild(piece);
        });
    }

    function addDragLogic(el) {
        let startX, startY;
        
        const start = (e) => {
            if(e.type === 'touchstart') e.preventDefault();
            const pt = e.type === 'touchstart' ? e.touches[0] : e;
            startX = pt.clientX;
            startY = pt.clientY;
            
            // Initial relative pos logic
            el.dataset.tx = el.dataset.tx || 0;
            el.dataset.ty = el.dataset.ty || 0;
            
            el.style.zIndex = 100;
            el.style.cursor = 'grabbing';
            playSound('pop'); // pop sound on pickup
        };

        const move = (e) => {
            if (el.style.cursor !== 'grabbing') return;
            if(e.type === 'touchmove') e.preventDefault(); // Stop scroll
            const pt = e.type === 'touchmove' ? e.touches[0] : e;
            
            const dx = pt.clientX - startX;
            const dy = pt.clientY - startY;
            
            const currentTx = parseFloat(el.dataset.tx) + dx;
            const currentTy = parseFloat(el.dataset.ty) + dy;
            
            el.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(1.1)`;
        };

        const end = (e) => {
            if (el.style.cursor !== 'grabbing') return;
            el.style.zIndex = 10;
            el.style.cursor = 'grab';
            
            // Check Collision with Targets
            const pieceRect = el.getBoundingClientRect();
            const pieceCenter = { x: pieceRect.left + pieceRect.width/2, y: pieceRect.top + pieceRect.height/2 };
            
            let snapped = false;
            const targets = document.querySelectorAll('.target-slot:not(.filled)');
            
            targets.forEach(target => {
                if(snapped) return;
                const targetRect = target.getBoundingClientRect();
                const targetCenter = { x: targetRect.left + targetRect.width/2, y: targetRect.top + targetRect.height/2 };
                
                // Distance check (< 60px)
                const dist = Math.hypot(pieceCenter.x - targetCenter.x, pieceCenter.y - targetCenter.y);
                
                if (dist < 60) {
                    if (target.dataset.target === el.dataset.icon) {
                        // MATCH!
                        snapped = true;
                        playSound('snap');
                        target.classList.add('filled');
                        // Hide draggable
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                        shadowsSolved++;
                        
                        // WIN CONDITION
                        if(shadowsSolved === 3) {
                            setTimeout(() => {
                                handleWin();
                                // Change background theme logic
                                setTimeout(() => {
                                    // Pick NEW random theme (avoid same one)
                                    let newIdx = currentShadowThemeIndex;
                                    while(newIdx === currentShadowThemeIndex) {
                                        newIdx = Math.floor(Math.random() * shadowThemes.length);
                                    }
                                    currentShadowThemeIndex = newIdx;
                                    setShadowTheme(currentShadowThemeIndex);
                                    
                                    initShadowGame();
                                }, 3000);
                            }, 500);
                        }
                    }
                }
            });

            if (!snapped) {
                // Revert
                el.style.transition = 'transform 0.3s';
                el.style.transform = 'translate(0px, 0px)';
                el.dataset.tx = 0;
                el.dataset.ty = 0;
                setTimeout(() => { el.style.transition = 'transform 0.1s'; }, 300);
            }
        };

        el.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move); // Window listener for smooth drag outside bounds
        window.addEventListener('mouseup', end);
        
        el.addEventListener('touchstart', start, {passive: false});
        window.addEventListener('touchmove', move, {passive: false});
        window.addEventListener('touchend', end);
    }

    /* =========================================
       GLOBAL UTILS
       ========================================= */
    function handleWin() {
        playSound('win'); fireConfetti();
        const winText = document.getElementById('win-text');
        winText.style.opacity = '1';
        setTimeout(() => { winText.style.opacity = '0'; }, 3000);
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const particles = [];
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
        for (let i = 0; i < 100; i++) particles.push({ x: window.innerWidth/2, y: window.innerHeight/2, w: Math.random()*10+5, h: Math.random()*10+5, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20, color: colors[Math.floor(Math.random()*colors.length)], life: 100 });
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); let active = false;
            particles.forEach(p => { if (p.life > 0) { active = true; p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.w, p.h); } });
            if (active) requestAnimationFrame(draw);
        }
        draw();
    }
</script>
</body>
</html>
